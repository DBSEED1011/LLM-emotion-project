---
title: "NRC_COT"
author: "dyq"
date: "2025-07-27"
output: html_document
---

```{r set}
#å®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…
install.packages("syuzhet")
install.packages("writexl")
library(syuzhet)
library(readxl)
library(writexl)
library(tidyverse)
install.packages("tidytext")
library(tidytext)

```



```{r cars}
# è¯»å–æ•°æ®

file_path <- "~/Desktop/Reasoning_content_analysis/Reasoning_example.xlsx"

# è¯»å–æ•°æ®
df <- read_excel(file_path)

# æŸ¥çœ‹åˆ—å
colnames(df)

# æå– Reasoning åˆ—
text_data <- df$Reasoning

# æŸ¥çœ‹å‰å‡ è¡Œæ–‡æœ¬ï¼ˆå¯é€‰ï¼‰
head(text_data)

```
```{r}
#word frequency analysis
# åŠ è½½å¿…è¦çš„åŒ…

library(dplyr)
library(stringr)
library(tibble)
library(tidyr)
library(ggplot2)
library(stopwords)
library(readr)
library(tidytext)

```

```{r}
# è®¾ç½®æ–‡ä»¶è·¯å¾„ï¼ˆMac è·¯å¾„æ³¨æ„ ~ è¡¨ç¤ºç”¨æˆ·æ ¹ç›®å½•ï¼‰
folder_path <- "~/Desktop/Reasoning_content_analysis/"
deepseek_file <- paste0(folder_path, "Reasoning_example.xlsx")
human_file <- paste0(folder_path, "Human_reasoning.xlsx")

# è‡ªå®šä¹‰åœç”¨è¯
custom_stopwords <- c("vs", "avg", "1", "2", "acvalence", "aavalence", "acarousal", "aarousal","s")

# è¯»å– Reasoning åˆ—ï¼ˆé»˜è®¤ Sheet1ï¼‰
deepseek_df <- read_excel(deepseek_file, sheet = "Sheet1") %>%
  select(Reasoning) %>%
  drop_na() %>%
  mutate(Source = "DeepSeek-R1")

human_df <- read_excel(human_file, sheet = "Sheet1") %>%
  select(Reasoning) %>%
  drop_na() %>%
  mutate(Source = "Human")

# åˆå¹¶æ•°æ®
combined_df <- bind_rows(deepseek_df, human_df)

# åˆ†è¯ + æ¸…æ´—
tidy_words <- combined_df %>%
  unnest_tokens(word, Reasoning) %>%
  mutate(word = str_to_lower(word)) %>%
  filter(!word %in% stopwords("en"),
         !word %in% custom_stopwords,
         str_detect(word, "^[a-z]+$"))  # ä»…ä¿ç•™çº¯å­—æ¯è¯

# è¯é¢‘ç»Ÿè®¡
word_freq <- tidy_words %>%
  count(Source, word, sort = TRUE)

# åˆ†åˆ«ä¿å­˜è¯é¢‘ç»Ÿè®¡ç»“æœ
deepseek_freq <- word_freq %>% filter(Source == "DeepSeek-R1")
human_freq <- word_freq %>% filter(Source == "Human")

write_csv(deepseek_freq, paste0(folder_path, "DeepSeek_R1_Word_Frequency.csv"))
write_csv(human_freq, paste0(folder_path, "Human_Word_Frequency.csv"))

```

```{r}
# ======== å‡†å¤‡å·¥ä½œ ========
library(tidyverse)
library(wordcloud)
library(RColorBrewer)
library(viridis)

# è®¾ç½®é¢œè‰²
cols <- viridis(100)  # æˆ–è€… brewer.pal(8, "PuBuGn")

# å…¬å…±å‚æ•°
WC_MAX_WORDS <- 150
WC_MIN_FREQ  <- 3
WC_SCALE     <- c(6, 0.8)
WC_ROT_PER   <- 0.05

cols <- rev(viridis(100))


# ======== åŠ è½½æ•°æ® ========
human <- read.csv("~/Desktop/LLMæƒ…æ„Ÿæœºåˆ¶/Reasoning_content_analysis/Human_Word_Frequency.csv")
deepseek <- read.csv("~/Desktop/LLMæƒ…æ„Ÿæœºåˆ¶/Reasoning_content_analysis/DeepSeek_R1_Word_Frequency.csv")

# æ”¹åˆ—å
colnames(human)[colnames(human) == "n"] <- "freq"
colnames(deepseek)[colnames(deepseek) == "n"] <- "freq"

# ======== ä¿å­˜å‡½æ•° ========
save_wordcloud <- function(word_freq, outfile){
  if(nrow(word_freq) == 0){
    warning(paste("No words to plot for", outfile))
    return(invisible(NULL))
  }
  png(outfile, width = 2000, height = 1500, res = 300)
  par(mar = c(1,1,1,1))
  wordcloud(
    words        = word_freq$word,
    freq         = word_freq$freq,
    max.words    = WC_MAX_WORDS,
    min.freq     = WC_MIN_FREQ,
    random.order = FALSE,
    rot.per      = WC_ROT_PER,
    scale        = WC_SCALE,
    colors       = cols
  )
  dev.off()
  message("Saved: ", outfile)
}


# ======== ç”Ÿæˆè¯äº‘ ========
set.seed(123)  # æˆ– 123ï¼Œç»Ÿä¸€å³å¯
save_wordcloud(human, "Human_WordCloud.png")
save_wordcloud(deepseek, "DeepSeek_WordCloud.png")



```



```{r}

# ====== è¯»å–æ•°æ® ======
file_path <- "~/Desktop/Reasoning_example.xlsx"
df <- read_excel(file_path)

# ç®€å•æ£€æŸ¥
print(colnames(df))
print(head(df$Reasoning))

# ==== æ„å»ºè¯é¢‘è¡¨ ====
word_freq <- df %>%
  unnest_tokens(word, Reasoning) %>%
  filter(str_detect(word, "[a-z]")) %>%
  anti_join(stop_words, by = "word") %>%
  count(word, sort = TRUE)

# è‡ªå®šä¹‰è¦åˆ é™¤çš„æ— å…³è¯
drop_words <- c("avg", "ac_valence", "aa_valence", "ac_arousal", "aa_arousal","aa","ac","player")
word_freq <- word_freq %>%
  filter(!word %in% drop_words)

# ==== ç»˜åˆ¶é«˜åˆ†è¾¨ç‡è¯äº‘ ====
png("~/Desktop/wordcloud_hires.png", width = 2000, height = 1500, res = 300)

par(mar = c(1,1,1,1))  # ç¼©å°è¾¹è·ï¼Œç•™æ›´å¤šç©ºé—´
set.seed(123)
wordcloud(
  words        = word_freq$word,
  freq         = word_freq$n,
  max.words    = 300,             # æ˜¾ç¤º 100~200 è¯
  min.freq     = 3,               # è¿‡æ»¤æ‰ä½é¢‘è¯
  random.order = FALSE,
  rot.per      = 0.05,            # 5% ç«–æ’ï¼Œå‡å°‘ç¢°æ’
  scale        = c(6, 0.8),       # æœ€å¤§/æœ€å°å­—ä½“å¤§å°
  colors       = viridis(100)     # é¢œè‰²æ–¹æ¡ˆï¼ˆæ”¹æˆ brewer.pal ä¹Ÿè¡Œï¼‰
)

dev.off()

```



```{r}

# ====== è¯»å–æ•°æ® ======
file_path <- "~/Desktop/LLMæƒ…æ„Ÿæœºåˆ¶/Reasoning_content_analysis/Human_reasoning.xlsx"
df <- read_excel(file_path)

# ç®€å•æ£€æŸ¥
print(colnames(df))
print(head(df$Reasoning))

# é¢œè‰²æ–¹æ¡ˆï¼ˆä¸¤å¼ ç»Ÿä¸€ï¼Œä¾¿äºå¯¹æ¯”ï¼‰
cols <- viridis(100)  # æˆ–è€… brewer.pal(8, "PuBuGn")

# è¯äº‘ç»˜å›¾å…¬å…±å‚æ•°
WC_MAX_WORDS <- 150
WC_MIN_FREQ  <- 3
WC_SCALE     <- c(6, 0.8)   # æœ€å¤§/æœ€å°å­—ä½“
WC_ROT_PER   <- 0.05

cols <- rev(viridis(100))


# ====== å°å·¥å…·å‡½æ•°ï¼šæ„å»ºè¯é¢‘è¡¨ ======
build_word_freq <- function(data){
  data %>%
    filter(!is.na(Reasoning)) %>%
    unnest_tokens(word, Reasoning) %>%
    filter(str_detect(word, "[a-z]")) %>%       # è‹±æ–‡è¯
    anti_join(stop_words, by = "word") %>%      # å»åœç”¨è¯
    count(word, sort = TRUE) %>%
    filter(!word %in% drop_words)               # å»è‡ªå®šä¹‰è¯
}

# ====== å°å·¥å…·å‡½æ•°ï¼šä¿å­˜é«˜åˆ†è¾¨ç‡è¯äº‘ï¼ˆæ”¹ä¸ºæ–¹å½¢ + pty='s'ï¼‰ ======
save_wordcloud <- function(word_freq, outfile){
  if(nrow(word_freq) == 0){
    warning(paste("No words to plot for", outfile))
    return(invisible(NULL))
  }
  png(outfile, width = 2000, height = 1500, res = 300)  # æ–¹å½¢ç”»å¸ƒ
  par(mar = c(1,1,1,1), pty = "s")                      # æ–¹å½¢ç»˜å›¾åŒº
  set.seed(123)
  wordcloud(
    words        = word_freq$word,
    freq         = word_freq$n,
    max.words    = WC_MAX_WORDS,
    min.freq     = WC_MIN_FREQ,
    random.order = FALSE,
    rot.per      = WC_ROT_PER,
    scale        = WC_SCALE,
    colors       = cols
  )
  dev.off()
  message("Saved: ", outfile)
}

# ====== å…ˆåšä¸€ä¸ªâ€œä¸åˆ† choiceâ€çš„æ•´ä½“å›¾ ======
wf_all <- build_word_freq(df)
save_wordcloud(wf_all, "~/Desktop/wordcloud_Humans_all_sq.png")


```

```{r}
install.packages("textdata")
library(textdata)   # NRC-VAD / Warriner ç­‰è¯å…¸

# è¯»å…¥ NRC-VAD
vad <- textdata::lexicon_nrc_vad() %>%
  transmute(word = tolower(term),
            valence = valence,
            arousal = arousal) %>%
  distinct(word, .keep_all = TRUE)

# tidytext æ–¹å¼ï¼šæŠŠæ–‡æœ¬æ‹†æˆè¯å join è¯å…¸
tidy_tokens <- df_clean %>%
  mutate(row_id = row_number()) %>%
  unnest_tokens(word, reason_txt, token = "words") %>%
  filter(str_detect(word, "[a-z]"))

# 3a) Valence/Arousal çš„â€œå‡å€¼æ‰“åˆ†â€ï¼ˆå¸¸è§äºæ–‡çŒ®ï¼‰
va_scores_mean <- tidy_tokens %>%
  left_join(vad, by = "word") %>%
  group_by(row_id) %>%
  summarise(
    n_tokens = n(),
    valence_raw = if (all(is.na(valence))) NA_real_ else mean(valence, na.rm = TRUE),
    arousal_raw = if (all(is.na(arousal))) NA_real_ else mean(arousal, na.rm = TRUE),
    .groups = "drop"
  )

# 3b) Valence/Arousal çš„â€œå‘½ä¸­é¢‘ç‡â€ï¼ˆå‡ºç°å³è®¡æ•°ï¼‰
va_scores_freq <- tidy_tokens %>%
  inner_join(vad %>% select(word), by = "word") %>%
  count(row_id, name = "va_hit") %>%
  right_join(df_clean %>% mutate(row_id = row_number()), by = "row_id") %>%
  mutate(va_freq = replace_na(va_hit, 0)) %>%
  select(row_id, va_freq)

```


## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
# ğŸ’¡ ä½¿ç”¨ NRC æƒ…ç»ªè¯å…¸è¿›è¡Œæƒ…ç»ªåˆ†æ
nrc_result <- get_nrc_sentiment(text_data)

# ğŸ§¾ æŸ¥çœ‹å‰å‡ è¡Œç»“æœ
head(nrc_result)

```

```{r}

# åˆå¹¶å›åŸå§‹æ•°æ®
df_with_emotions <- cbind(df, nrc_result)
##æ„ŸçŸ¥çš„å…¬å¹³ç›¸å…³
# ğŸ§  å®šä¹‰ä¸å…¬å¹³å…³é”®è¯
unfair_keywords <- c("unfair", "unfairness", "unequal", "injustice", "biased", "not fair")

# âœ‚ï¸ æŠŠæ–‡æœ¬è½¬ä¸ºå°å†™ç”¨äºåŒ¹é…
text_lower <- tolower(df_with_emotions$Reasoning)

# âœ… ç»Ÿè®¡ä¸å…¬å¹³å…³é”®è¯åœ¨æ¯æ®µæ–‡æœ¬ä¸­å‡ºç°çš„æ¬¡æ•°ï¼ˆä½œä¸ºå¾—åˆ†ï¼‰
df_with_emotions$unfair_score <- str_count(text_lower, str_c(unfair_keywords, collapse = "|"))

# âœ… ä¹Ÿå¯ä»¥åŠ ä¸€åˆ—å¸ƒå°”å˜é‡ï¼ˆæ˜¯å¦åŒ…å«è‡³å°‘ä¸€ä¸ªä¸å…¬å¹³è¯ï¼‰
df_with_emotions$contains_unfair <- df_with_emotions$unfair_score > 0

```

```{r pressure, echo=FALSE}

# è®¾ç½®å¯¼å‡ºè·¯å¾„
output_path <- "~/Desktop/Reasoning_with_emotions.xlsx"

# å¯¼å‡ºä¸º Excel æ–‡ä»¶
write_xlsx(df_with_emotions, output_path)

```



```{r}
##åˆæ­¥çš„ç›¸å…³æ€§åˆ†æ
library(ggcorrplot)

#âœ… å¼ºåˆ¶è½¬æ¢ä¸º numericï¼Œé˜²æ­¢æœ‰å˜é‡ä¸æ˜¯ numeric å¯¼è‡´è¢« cor() æ’é™¤
emotion_data <- as.data.frame(lapply(emotion_data, as.numeric))

# âœ… è®¡ç®—ç›¸å…³çŸ©é˜µ
cor_matrix <- cor(emotion_data, use = "complete.obs", method = "pearson")

# âœ… è®¾ç½®å˜é‡åï¼ˆé¿å… ggcorrplot å‡ºç°é—®é¢˜ï¼‰
vars12 <- emotion_vars_with_choice
vars12[vars12 == "choice_num"] <- "Punishment"
vars12[vars12 == "unfair_score"] <- "Perceived Unfairness"
colnames(cor_matrix) <- vars12
rownames(cor_matrix) <- vars12

# âœ… ç”»ç›¸å…³å›¾ï¼ˆ12x12ï¼‰
ggcorrplot(cor_matrix,
           type = "full",
           lab = TRUE,
           lab_size = 2.5,
           tl.cex = 0.8,
           tl.srt = 45,
           colors = c("blue", "white", "red"),
           title = "Correlation: Emotions, Unfairness, and Choice") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10))


```
```{r}
#ç®€ç•¥ç‰ˆæœ¬Correlation Table

# ---- å¿…è¦åŒ… ----
# å¦‚æœæ²¡è£…è¯·å…ˆå®‰è£…ï¼šinstall.packages(c("readxl", "ggcorrplot", "ggplot2"))
#library(readxl)
#library(ggcorrplot)
#library(ggplot2)

# ---- 1) è¯»å– Excelï¼ˆæŒ‰ä½ çš„è·¯å¾„ï¼‰----
path <- "/Users/Daiyiqing/Desktop/Reasoning_with_emotions.xlsx"
raw <- read_excel(path)

# ---- 2) åªé€‰ 4 ä¸ªç›®æ ‡å˜é‡ï¼ˆå¤§å°å†™ä¸æ•æ„ŸåŒ¹é…åŸå§‹åˆ—åï¼‰----
orig_keys <- c("choice", "negative", "positive", "unfair_score")
# åœ¨æ•°æ®é‡ŒæŒ‰å¿½ç•¥å¤§å°å†™æ‰¾å¯¹åº”åˆ—
name_map <- setNames(names(raw), tolower(names(raw)))
pick_names <- name_map[orig_keys]  # è¿”å›ä¸ orig_keys å¯¹åº”çš„å®é™…åˆ—åï¼ˆå¯èƒ½å¤§å°å†™ä¸åŒï¼‰

# æ£€æŸ¥ç¼ºå¤±
if (anyNA(pick_names)) {
  stop(
    paste0(
      "ä¸‹åˆ—å˜é‡åœ¨è¡¨ä¸­æ‰¾ä¸åˆ°ï¼š",
      paste(orig_keys[is.na(pick_names)], collapse = ", "),
      "ã€‚è¯·æ ¸å¯¹å·¥ä½œè¡¨çš„åˆ—åã€‚"
    )
  )
}

df4 <- raw[ , pick_names]

# ---- 3) è½¬ numericï¼ˆåªå¯¹è¿™ 4 åˆ—ï¼›å°½é‡å®½å®¹åœ°å¤„ç†å­—ç¬¦/å› å­ï¼‰----
numify <- function(x) {
  if (is.numeric(x)) return(x)
  x <- as.character(x)
  x <- gsub(",", ".", x)                 # é€—å·å°æ•° -> ç‚¹
  x <- gsub("[^0-9\\-\\.]", "", x)       # å»éæ•°å­—ï¼ˆä¿ç•™è´Ÿå·/å°æ•°ç‚¹ï¼‰
  suppressWarnings(as.numeric(x))        # è½¬æ•°å­—ï¼ˆå¯èƒ½ä¼šå¼•å…¥ NAï¼‰
}
df4 <- as.data.frame(lapply(df4, numify))

# è‹¥æŸåˆ—å…¨ NAï¼Œç›´æ¥æŠ¥é”™æé†’
all_na_cols <- names(df4)[colSums(!is.na(df4)) == 0]
if (length(all_na_cols) > 0) {
  stop(paste("è¿™äº›åˆ—åœ¨æ•°å€¼åŒ–åå…¨æ˜¯ NAï¼š", paste(all_na_cols, collapse = ", "),
             "ã€‚è¯·æ£€æŸ¥åŸå§‹æ•°æ®å†…å®¹/ç¼–ç ã€‚"))
}

# ---- 4) æ”¹å±•ç¤ºåï¼ˆé¿å… ggcorrplot æ ‡ç­¾é—®é¢˜ï¼‰----
display_names <- c("Punishment", "Negative Emotions",
                   "Positive Emotions", "Perceived Unfairness")
names(df4) <- display_names

# ---- 5) è®¡ç®— 4Ã—4 ç›¸å…³çŸ©é˜µï¼ˆpairwiseï¼Œé¿å… complete.obs è¿‡è‹›ï¼‰----
cor_4 <- cor(df4, use = "pairwise.complete.obs", method = "pearson")

# ---- 6) ç”»ç›¸å…³å›¾ï¼ˆTimes New Romanï¼‰----
p <- ggcorrplot(
  cor_4,
  type = "full",
  lab = TRUE,
  lab_size = 4,
  tl.cex = 12,
  tl.srt = 45,
  colors = c("blue", "white", "red"),
  title = "Correlation: Perceived Unfairness, Emotions and Punishment"
) +
  theme(
    plot.title = element_text(hjust = 0.5, color = "black"),
    axis.text.x = element_text(size = 12, color = "black"),
    axis.text.y = element_text(size = 12, color = "black"),
    text = element_text(family = "Times New Roman", color = "black")
  )

print(p)



```

```{r}
#ç›¸å…³æ€§åˆ†æç»Ÿè®¡æ•°æ®
# ä½ è¦åˆ†æçš„å˜é‡
vars <- c("anger", "anticipation", "disgust", "fear", "joy",
          "sadness", "surprise", "trust", "negative", "positive",
          "unfair_score", "choice")

# Step 1: è¯»å–æ•°æ®
df_with_emotions <- read_excel("~/Desktop/Reasoning_with_emotions.xlsx")

# ç¡®ä¿ choice æ˜¯ numericï¼ˆç”¨äº corï¼‰
df_with_emotions$choice_num <- as.numeric(as.character(df_with_emotions$choice))

# æå–å­æ•°æ®æ¡†
df_corr <- df_with_emotions[, c(vars[1:11], "choice")]  # ç”¨ choice_num æ›¿ä»£ choice
colnames(df_corr)[12] <- "choice"  # æ”¹å›åˆ—å

# åˆå§‹åŒ–ç»“æœè¡¨
cor_results <- data.frame()

# éå†æ‰€æœ‰å˜é‡å¯¹ï¼ˆä¸Šä¸‰è§’ï¼‰
for (i in 1:(length(vars) - 1)) {
  for (j in (i + 1):length(vars)) {
    var1 <- vars[i]
    var2 <- vars[j]
    
    # Pearson correlation test
    test <- cor.test(df_corr[[var1]], df_corr[[var2]], use = "complete.obs", method = "pearson")
    
    # æ˜¾è‘—æ€§æ˜Ÿå·
    sig <- ifelse(test$p.value < 0.001, "***",
                  ifelse(test$p.value < 0.01, "**",
                         ifelse(test$p.value < 0.05, "*", "")))
    
    cor_results <- rbind(cor_results, data.frame(
      var1 = var1,
      var2 = var2,
      correlation = round(test$estimate, 3),
      p_value = signif(test$p.value, 3),
      significance = sig
    ))
  }
}

# æŸ¥çœ‹ç»“æœ
library(knitr)
kable(cor_results, caption = "æƒ…ç»ªå˜é‡ã€unfair_score ä¸ choice çš„ç›¸å…³æ€§çŸ©é˜µï¼ˆå«æ˜¾è‘—æ€§ï¼‰")



```

```{r}
#descriptive data

file_path <- "~/Desktop/Reasoning_with_emotions.xlsx"
# è¯»å–æ•°æ®
df <- read_excel(file_path)

df_with_emotions <- read_excel(file_path)

head (file_path)

# ç¡®ä¿ choice æ˜¯å› å­å‹å˜é‡
df_with_emotions$choice <- as.factor(df_with_emotions$choice)

# 1ï¸âƒ£ ç»Ÿè®¡å„ç±»æƒ©ç½šé€‰æ‹©æ•°é‡
table(df_with_emotions$choice)

# æˆ–ç”¨ tidyverse ç¾è§‚å±•ç¤º
library(dplyr)
df_with_emotions %>%
  group_by(choice) %>%
  summarise(n = n())

# 2ï¸âƒ£ è®¡ç®—æ¯ç»„çš„æƒ…ç»ªå˜é‡å¹³å‡å€¼ï¼ˆæˆ–ä¸­ä½æ•°ï¼‰
emotion_vars <- c("anger", "anticipation", "disgust", "fear", "joy",
                  "sadness", "surprise", "trust", "negative", "positive", "unfair_score")

# åˆ†ç»„å‡å€¼
group_summary <- df_with_emotions %>%
  group_by(choice) %>%
  summarise(across(all_of(emotion_vars), mean, na.rm = TRUE))

# æŸ¥çœ‹ç»“æœ
print(group_summary)

library(knitr)

group_summary %>%
  kable(digits = 3, caption = "æ¯ç»„ choice çš„æƒ…ç»ªå˜é‡å¹³å‡å€¼")


```
```{r}

# ğŸ“¦ åŠ è½½å¿…è¦åŒ…
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(openxlsx)

# 1ï¸âƒ£ è¯»å–æ•°æ®
file_path <- "~/Desktop/Reasoning_with_emotions.xlsx"
df <- read_excel(file_path)

# 2ï¸âƒ£ choice è½¬ä¸ºå› å­
df$choice <- as.factor(df$choice)

# 3ï¸âƒ£ è®¾ç½®æƒ…ç»ªç»´åº¦å˜é‡
emotion_vars <- c("anger", "anticipation", "disgust", "fear", "joy",
                  "sadness", "surprise", "trust", "negative", "positive", "unfair_score")

# 4ï¸âƒ£ å¼ºåˆ¶è½¬æ¢ä¸ºæ•°å€¼å‹
df[emotion_vars] <- lapply(df[emotion_vars], function(x) as.numeric(as.character(x)))

# 5ï¸âƒ£ åš t æ£€éªŒå¹¶æ±‡æ€»
t_test_results <- lapply(emotion_vars, function(var) {
  group0 <- df[df$choice == "0", var]
  group1 <- df[df$choice == "1", var]
  
  group0 <- group0[!is.na(group0)]
  group1 <- group1[!is.na(group1)]
  
  t_res <- t.test(group0, group1)
  
  data.frame(
    emotion = var,
    mean_0 = mean(group0),
    mean_1 = mean(group1),
    t_value = round(t_res$statistic, 3),
    p_value = round(t_res$p.value, 5),
    significance = case_when(
      t_res$p.value < 0.001 ~ "***",
      t_res$p.value < 0.01  ~ "**",
      t_res$p.value < 0.05  ~ "*",
      TRUE ~ ""
    )
  )
}) %>% bind_rows()

# ğŸ” é‡å‘½å emotion åç”¨äºæ˜¾ç¤º
t_test_results$emotion <- recode(t_test_results$emotion,
                                 "unfair_score" = "Perceived Unfairness")

# âœ… æ‰“å° t æ£€éªŒç»“æœ
print(t_test_results)

# ğŸ’¾ ä¿å­˜ä¸º Excel
write.xlsx(t_test_results, "~/Desktop/t_test_results.xlsx")

# 6ï¸âƒ£ å¤„ç†ç»˜å›¾æ•°æ®
emotion_long <- df %>%
  pivot_longer(cols = all_of(emotion_vars),
               names_to = "emotion",
               values_to = "score")

# æ›¿æ¢ emotion åç”¨äºæ˜¾ç¤º
emotion_long$emotion <- recode(emotion_long$emotion,
                                "unfair_score" = "Perceived Unfairness")

# âœ… è®¡ç®—å‡å€¼å’Œè¯¯å·®çº¿
summary_scores <- emotion_long %>%
  group_by(choice, emotion) %>%
  summarise(
    mean_score = mean(score, na.rm = TRUE),
    sd = sd(score, na.rm = TRUE),
    n = sum(!is.na(score)),
    se = sd / sqrt(n),
    ci = se * qt(0.975, df = n - 1),  # 95% CI
    .groups = "drop"
  )

# åˆå¹¶æ˜¾è‘—æ€§ä¿¡æ¯
summary_scores <- left_join(summary_scores, t_test_results[, c("emotion", "significance")], by = "emotion")

# âœ… ä¿®æ”¹ choice æ ‡ç­¾
summary_scores$choice <- factor(summary_scores$choice,
                                levels = c("0", "1"),
                                labels = c("Accept", "Punish"))

# å– Punish ç»„åšæ˜¾è‘—æ€§æ ‡è®°
label_data <- summary_scores %>% filter(choice == "Punish")

# è®¾ç½® emotion å› å­çš„æ˜¾ç¤ºé¡ºåºï¼ŒæŠŠ "Perceived Unfairness" æ”¾æœ€å
emotion_order <- summary_scores %>%
  distinct(emotion) %>%
  pull(emotion) %>%
  setdiff("Perceived Unfairness") %>%
  c("Perceived Unfairness")

summary_scores$emotion <- factor(summary_scores$emotion, levels = emotion_order)
label_data$emotion <- factor(label_data$emotion, levels = emotion_order)


# ğŸ“Š ç»˜å›¾ï¼šå¸¦ç½®ä¿¡åŒºé—´å’Œæ˜¾è‘—æ€§æ˜Ÿå·
ggplot(summary_scores, aes(x = emotion, y = mean_score, fill = choice)) +
  geom_bar(stat = "identity", position = position_dodge(0.9)) +
  geom_errorbar(aes(ymin = mean_score - ci, ymax = mean_score + ci),
                position = position_dodge(0.9),
                width = 0.2) +
  geom_text(data = label_data,
            aes(label = significance, y = mean_score + ci + 0.3),
            position = position_dodge(width = 0.9),
            vjust = 0) +
  labs(title = "Perceived Unfairness and Emotional Variables by Punishment Choice",
       y = "Mean Score Â± 95% CI", fill = "Decision") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```




```{r}
#å»ºç«‹æ¨¡å‹æ¢ç´¢
# Install packages
install.packages("psych")
install.packages("lavaan")
install.packages("ggplot2")
install.packages("readxl")
install.packages("semPlot")
install.packages("sem")
install.packages("jpeg")


# Load packages
library(psych)
library(lavaan)
library(ggplot2)
library(readxl)
library(sem)
library(semPlot)

```

```{r}
library(lavaan)

# ç¡®ä¿ choice ä¸ºäºŒå…ƒæœ‰åºå˜é‡ï¼ˆå¦‚æœè¿˜æ²¡åšï¼‰
df$choice <- as.numeric(df$choice)

# å®šä¹‰å¸¦æ§åˆ¶å˜é‡çš„æ¨¡å‹
model <- '
  negative ~ a * unfair_score + amount_of_cost
  choice ~ b * negative + c * unfair_score + amount_of_cost

  indirect := a * b
  total := c + (a * b)
'

# æ‹Ÿåˆæ¨¡å‹
fit <- sem(model, data = df, estimator = "WLSMV", ordered = "choice")

# æŸ¥çœ‹ç»“æœ
summary(fit, standardized = TRUE, fit.measures = TRUE)


         
```

```{r}
# å¿…è¦åŒ…
# install.packages(c("readxl", "lavaan"))
library(readxl)
library(lavaan)

# ===== 1) è¯»å–æ•°æ®ï¼ˆæŒ‰ä½ çš„å®é™…è·¯å¾„ï¼‰=====
path <- "/Users/Daiyiqing/Desktop/Reasoning_with_emotions.xlsx"
raw  <- read_excel(path)

# ===== 2) åªå–å»ºæ¨¡æ‰€éœ€å˜é‡ï¼ˆå¤§å°å†™ä¸æ•æ„ŸåŒ¹é…ï¼‰=====
need_vars <- c("negative", "positive", "unfair_score", "amount_of_cost", "choice")
name_map  <- setNames(names(raw), tolower(names(raw)))
hit       <- name_map[need_vars]

if (anyNA(hit)) {
  stop(paste(
    "ä»¥ä¸‹åˆ—åœ¨è¡¨ä¸­æ‰¾ä¸åˆ°ï¼š",
    paste(need_vars[is.na(hit)], collapse = ", "),
    "\nè¯·æ£€æŸ¥å·¥ä½œè¡¨åˆ—åã€‚å®é™…åˆ—åç¤ºä¾‹ï¼š", paste(names(raw)[1:min(10, ncol(raw))], collapse = ", ")
  ))
}

df <- raw[, hit]
names(df) <- need_vars  # ç»Ÿä¸€æˆæ ‡å‡†å

# ===== 3) æ•°å€¼åŒ–å¤„ç†ï¼ˆä»…å¯¹æ•°å€¼/å­—ç¬¦åˆ—ï¼›å°½é‡ä¿ç•™æ•°å­—ï¼‰=====
numify <- function(x){
  if (is.numeric(x)) return(x)
  x <- as.character(x)
  x <- gsub(",", ".", x)                 # é€—å·å°æ•° -> ç‚¹
  x <- gsub("[^0-9\\-\\.]", "", x)       # å»æ‰éæ•°å­—å­—ç¬¦ï¼ˆä¿ç•™-å’Œ.ï¼‰
  suppressWarnings(as.numeric(x))
}
df$negative       <- numify(df$negative)
df$positive       <- numify(df$positive)
df$unfair_score   <- numify(df$unfair_score)
df$amount_of_cost <- numify(df$amount_of_cost)

# ===== 4) æ„é€ äºŒå…ƒæœ‰åº choice =====
# å¦‚æœæœ¬æ¥å°±æ˜¯0/1æ•°å­—ï¼Œç›´æ¥ç”¨ï¼›å¦åˆ™å°è¯•å‹ç¼©åˆ°äºŒå…ƒå¹¶æ˜ å°„åˆ°0/1
if (is.numeric(df$choice)) {
  # è‹¥ä¸æ˜¯0/1ä½†åªæœ‰ä¸¤ç§ä¸åŒæ•°å€¼ï¼Œä¹Ÿæ˜ å°„åˆ°0/1
  uniq <- sort(unique(na.omit(df$choice)))
  if (length(uniq) == 2 && !all(uniq %in% c(0,1))) {
    df$choice <- ifelse(df$choice == uniq[1], 0,
                        ifelse(df$choice == uniq[2], 1, NA))
  }
} else {
  # å­—ç¬¦/å› å­ï¼šå–å‡ºç°é¢‘ç‡ä»å°åˆ°å¤§æ˜ å°„ä¸º 0/1
  lev <- unique(na.omit(as.character(df$choice)))
  if (length(lev) != 2) {
    stop(paste("choice ä¸æ˜¯äºŒå…ƒå˜é‡ï¼ˆæ£€æµ‹åˆ°æ°´å¹³æ•°ï¼š", length(lev), "ï¼‰ã€‚è¯·æ£€æŸ¥æ•°æ®ã€‚"))
  }
  df$choice <- ifelse(as.character(df$choice) == lev[1], 0,
                      ifelse(as.character(df$choice) == lev[2], 1, NA))
}

# è®¾ä¸ºæœ‰åºå› å­ï¼ˆlavaan å¯¹ ordered å˜é‡æ›´ç¨³ï¼‰
df$choice <- ordered(df$choice, levels = c(0,1))

# ===== 5) åˆ å»ç”¨äºæ¨¡å‹çš„ç¼ºå¤±ï¼ˆWLSMVå¯¹ç¼ºå¤±è¾ƒæ•æ„Ÿï¼Œå»ºè®®å®Œæ•´æ¡ˆä¾‹ï¼‰=====
keep <- complete.cases(df[, c("negative","positive","unfair_score","amount_of_cost","choice")])
df   <- df[keep, ]

if (nrow(df) < 10) {
  stop("æœ‰æ•ˆæ ·æœ¬é‡è¿‡å°ï¼ˆ<10ï¼‰ã€‚è¯·æ£€æŸ¥ç¼ºå¤±å€¼æˆ–åŸå§‹æ•°æ®ã€‚")
}

# ===== 6) lavaan æ¨¡å‹ï¼ˆä¸æ‚¨ç»™çš„ä¸€è‡´ï¼‰=====
model <- '
  positive ~ a * unfair_score + amount_of_cost
  choice   ~ b * positive + c * unfair_score + amount_of_cost

  indirect := a * b
  total    := c + (a * b)
'

fit <- sem(model, data = df, estimator = "WLSMV", ordered = "choice")

# ===== 7) è¾“å‡ºç»“æœ =====
summary(fit, standardized = TRUE, fit.measures = TRUE)
parameterEstimates(fit, standardized = TRUE)  # å¦‚éœ€è¡¨æ ¼åŒ–ç³»æ•°

```






```{r}
##ç§¯ææ­£æƒ…ç»ªåé¦ˆå¾ªç¯

# Step 1: è¯»å–æ•°æ®
df <- read_excel("~/Desktop/Reasoning_with_emotions.xlsx")

# ç¡®ä¿å˜é‡æ ¼å¼æ­£ç¡®
df$choice <- as.numeric(df$choice)
df$choice_next <- as.ordered(df$choice_next)  # å¦‚æœæ˜¯äºŒå…ƒé€‰æ‹©
df$positive <- as.numeric(df$positive)

# å®šä¹‰ä¸­ä»‹æ¨¡å‹
model <- '
  positive ~ a * choice + amount_of_cost
  choice_next ~ b * positive + c * choice + amount_of_cost

  indirect := a * b
  total := c + (a * b)
'

# æ‹Ÿåˆæ¨¡å‹ï¼Œæ³¨æ„ ordered å˜é‡
fit <- sem(model, data = df, estimator = "WLSMV", ordered = "choice_next")

# æŸ¥çœ‹ç»“æœ
summary(fit, standardized = TRUE, fit.measures = TRUE)
```

```{r}
##æ¶ˆæè´Ÿæƒ…ç»ªåé¦ˆå¾ªç¯

# Step 1: è¯»å–æ•°æ®
df <- read_excel("~/Desktop/Reasoning_with_emotions.xlsx")

# ç¡®ä¿å˜é‡æ ¼å¼æ­£ç¡®
df$choice <- as.numeric(df$choice)
df$choice_next <- as.ordered(df$choice_next)  # å¦‚æœæ˜¯äºŒå…ƒé€‰æ‹©
df$negative <- as.numeric(df$negative)

# å®šä¹‰ä¸­ä»‹æ¨¡å‹
model <- '
  negative ~ a * choice + amount_of_cost
  choice_next ~ b * negative + c * choice + amount_of_cost

  indirect := a * b
  total := c + (a * b)
'

# æ‹Ÿåˆæ¨¡å‹ï¼Œæ³¨æ„ ordered å˜é‡
fit <- sem(model, data = df, estimator = "WLSMV", ordered = "choice_next")

# æŸ¥çœ‹ç»“æœ
summary(fit, standardized = TRUE, fit.measures = TRUE)

```
